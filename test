import random
import asyncio
import discord
import youtube_dl
from discord.ext import commands
import re
import sys
import os

# è‡ªåˆ†ã®Botã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã«ç½®ãæ›ãˆã¦ãã ã•ã„
TOKEN = 'OTU5NzA2NzUyNzgwMjM4OTI4.YkfykA.0uE2lCQ9kvY-skNMXQ6knDCcz1A'

# Suppress noise about console usage from errors
youtube_dl.utils.bug_reports_message = lambda: ''
bot = commands.Bot(command_prefix=commands.when_mentioned_or("-"))
discord_intents = discord.Intents.all()
client = discord.Client()
guild = discord.utils.get(client.guilds, name="åå‰")
omu_id = '<@582151968987021312>'
args = sys.argv

ytdl_format_options = {
    'format': 'bestaudio/best',
    'outtmpl': '%(extractor)s-%(id)s-%(title)s.%(ext)s',
    'restrictfilenames': True,
    'noplaylist': True,
    'nocheckcertificate': True,
    'ignoreerrors': False,
    'logtostderr': False,
    'quiet': True,
    'no_warnings': True,
    'default_search': 'auto',
    'source_address': '0.0.0.0' # bind to ipv4 since ipv6 addresses cause issues sometimes
}

ffmpeg_options = {
    'options': '-vn'
}

ytdl = youtube_dl.YoutubeDL(ytdl_format_options)


class YTDLSource(discord.PCMVolumeTransformer):
    def __init__(self, source, *, data, volume=0.5):
        super().__init__(source, volume)

        self.data = data

        self.title = data.get('title')
        self.url = data.get('url')

    @classmethod
    async def from_url(cls, url, *, loop=None, stream=False):
        loop = loop or asyncio.get_event_loop()
        data = await loop.run_in_executor(None, lambda: ytdl.extract_info(url, download=not stream))

        if 'entries' in data:
            # take first item from a playlist
            data = data['entries'][0]

        filename = data['url'] if stream else ytdl.prepare_filename(data)
        return cls(discord.FFmpegPCMAudio(filename, **ffmpeg_options), data=data)

# æ¥ç¶šã«å¿…è¦ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
client = discord.Client()

#é–¢æ•°
async def reply(message):
    reply = f'{message.author.mention} ã¯ï¼Ÿ' # è¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
    await message.channel.send(reply) # è¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
# def play_voice(text):
#     wav = tsukuyomichan_talksoft.generate_voice(text, 0)
#     sound = pydub.AudioSegment.from_wav("out.wav")
#     sound.export("out.mp3", format="mp3")
#     voiceChannel.play(FFmpegPCMAudio("out.mp3"))
# èµ·å‹•æ™‚ã«å‹•ä½œã™ã‚‹å‡¦ç†
@client.event
async def on_ready():
    # èµ·å‹•ã—ãŸã‚‰ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹
    print('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ')

@client.event
# bot = commands.Bot(
#     command_prefix="!",
#     activity=discord.Game("Qiita") # Qiitaã‚’ãƒ—ãƒ¬ã‚¤ä¸­
# )
# è¿”ä¿¡ã™ã‚‹éåŒæœŸé–¢æ•°ã‚’å®šç¾©
async def on_message(message: discord.Message):
    if client.user in message.mentions: # è©±ã—ã‹ã‘ã‚‰ã‚ŒãŸã‹ã®åˆ¤å®š
        await reply(message) # è¿”ä¿¡ã™ã‚‹éåŒæœŸé–¢æ•°ã‚’å®Ÿè¡Œ
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡è€…ãŒbotã ã£ãŸå ´åˆã¯ç„¡è¦–ã™ã‚‹
    if message.author.bot:
        return
    # ã€Œ/nekoã€ã¨ç™ºè¨€ã—ãŸã‚‰ã€Œã«ã‚ƒãƒ¼ã‚“ã€ãŒè¿”ã‚‹å‡¦ç†
    if re.search('ç¤¾ç•œ',message.content) :
        await message.channel.send('ãƒ¬ã‚”ã‚¡ã•ã‚“ï¼Ÿ')
    if re.search('ã‚ªã‚¦ãƒ«ã‚­ãƒ£ãƒƒãƒˆ',message.content) :
        await message.channel.send('æ–°èŒ¶ï¼Ÿ')
    if re.search('ç¤¾é©',message.content) :
        await message.channel.send('ãŠã‚€ï¼Ÿ')
    if re.search('å„ªç§€',message.content) or re.search('ã‚„ã‚‹',message.content):
        await message.channel.send('ã‚ã–ã™')
    if re.search('è‰¯',message.content) or re.search('ã‚ˆã•',message.content) or re.search('ã„ã„ã­',message.content):
        await message.channel.send('ã‚ã–ã™')
    if re.search('ã§ããŸ',message.content) or re.search('æˆé•·',message.content):
        await message.channel.send('ã›ã‚„ã‚')
    if re.search('ãƒŠã‚¤ã‚¹',message.content) or re.search('ãªã„ã™',message.content):
        await message.channel.send('ã‚„ã‚')
    if re.search('ç¤¾ä¸',message.content) :
        await message.channel.send('ãƒªãƒ´ã‚£ï¼Ÿ')
    if re.search('å§¦',message.content) :
        await message.channel.send('æ®´ã‚‹æ®´ã‚‹æ®´ã‚‹')
    if re.search('å¥³',message.content) :
        if re.search('å¹¼å¥³',message.content):
            await message.channel.send('å¯æ„›ã„')
        else:
            await message.add_reaction("ğŸ˜™")
            a = random.randrange(2)
            if a == 1:
                await message.channel.send('æ®´ã‚‹')
            else:
                await message.channel.send('å©ã')
        # print('')
    if message.content=='/neco':
        await message.channel.send('ã«ã‚ƒãƒ¼ã‚“')
        # print()
    if message.content=='p' or message.content=='P' or message.content=='ï½' or message.content=='ï¼°':
        id = '<@458621952299368469>'
        await message.channel.send(f'{id}')
    if message.content.startswith('!pouzu '):
        id = '<@458621952299368469>'
        pouzu = message.content[7:]
        for i in range(int(pouzu)):
            await message.channel.send(f'{id}')
            if i == 5:
                await message.channel.send("5å›ä»¥ä¸Šã¯å¯å“€æƒ³")
                break
    if re.search(f'{omu_id}',message.content) or re.search('!omu ',message.content):
        if re.search(f'{omu_id}',message.content):
            ms = message.content[21:]
        else:
            ms = message.content[4:]
        if str(args[1]) == 's':
            await message.channel.send('å–ã‚Šè¾¼ã¿ä¸­:ä¼ãˆã¨ã')
        print(message.guild,message.channel,message.author,str(ms))
    if message.content.startswith('!d '):
        n = message.content[3:]
        a = random.randrange(int(n))
        await message.channel.send(str(a))
    if message.content=='!help' or message.content=='!h':
        await message.channel.send("!join or !j : VCã«ç¹‹ã")
        await message.channel.send("!leave or !l : VCåˆ‡ã‚‹")
        await message.channel.send("!play or !p : æ›²æµã™ ex)!p å›ãŒä»£")
        await message.channel.send("!stop or !s : æ›²åœæ­¢")
        await message.channel.send("!d : ä¹±æ•° ex)!d 6")
        await message.channel.send("!omu : ãŠã‚€ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹")
    if message.content == "!join" or message.content == "!j":
        if message.author.voice is None:
            st = str(message.author)
            for i in range(len(st)):
                if st[i] == '#':
                    NAME = st[0:i]
            await message.channel.send("ã„ã‚„"+str(NAME)+"ãƒœã‚¤ãƒãƒ£ã«ã„ãªãã­ï¼Ÿ")
            return
        # ãƒœã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒãƒ«ã«æ¥ç¶šã™ã‚‹
        await message.author.voice.channel.connect()
        if str(message.guild) == 'é›·ç¥çª“':
            await message.channel.send("ã“ã‚“ã°ã‚“waaa")
        else:
            await message.channel.send("ã“ã‚“")
    elif message.content == "!leave" or message.content == "!l":
        if message.guild.voice_client is None:
            await message.channel.send("æ¥ç¶šã—ã¦ãªã„")
            return
        # åˆ‡æ–­ã™ã‚‹
        await message.guild.voice_client.disconnect()
        await message.channel.send("è½ã¡ã¾ã™ã€ãŠã¤ã§ã™")
        os.system("rm *.m4a")
        os.system("rm *.webm")
    elif message.content.startswith("!play ") or message.content.startswith("!p "):
        await message.channel.send("ã¡ã‚‡ã£ã¨å¾…ã£ã¦")
        if message.guild.voice_client is None:
            await message.channel.send("æ¥ç¶šã—ã¦ãªã„")
            return
        # å†ç”Ÿä¸­ã®å ´åˆã¯å†ç”Ÿã—ãªã„
        if message.guild.voice_client.is_playing():
            await message.channel.send("å¾…ã¦")
            return
        if message.content.startswith("!play "):
            url = message.content[6:]
        else:
            url = message.content[3:]
        # if os.path.isfile(url) = False
        # youtubeã‹ã‚‰éŸ³æ¥½ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        player = await YTDLSource.from_url(url, loop=client.loop)
        # å†ç”Ÿã™ã‚‹
        if message.content.startswith("!loop "):
             num = message.content[6:]
             for i in range(int(num)):
                 message.guild.voice_client.play(player)
                 if message.content == "!stop" or message.content == "!s":
                     message.guild.voice_client.stop()
                     await message.channel.send("ã¨ã‚ãŸã‚ˆ")
                     break
             return
        message.guild.voice_client.play(player)
        await message.channel.send(str(player.title) + ' ã‚’å†ç”Ÿ')
    elif message.content == "!stop" or message.content == "!s":
        if message.guild.voice_client is None:
            await message.channel.send("èª°ã‚‚ã„ã­ãƒ¼")
            return
        # å†ç”Ÿä¸­ã§ã¯ãªã„å ´åˆã¯å®Ÿè¡Œã—ãªã„
        if not message.guild.voice_client.is_playing():
            await message.channel.send("å†ç”Ÿã—ã¦ã„ã¾ã›ã‚“ã€‚")
            return
        message.guild.voice_client.stop()
        await message.channel.send("ã¨ã‚ãŸã‚ˆ")
    # play_voice(message.content)
# Botã®èµ·å‹•ã¨Discordã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶š
client.run(TOKEN)
